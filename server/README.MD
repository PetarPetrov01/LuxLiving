# Property Service REST API Documentation
|Contents
| ---
| [Authentication](#authorized-request)
| - [Register](#register)
| - [Login](#login)
| - [Logout](#logout)
| [Properties CRUD opeartions](#property-service)
| - [Get all](#get-all-properties)
| - [Get by ID](#get-single-property)
| - [Create](#create-property)
| - [Edit](#edit-property)
| - [Delete](#delete-property)
| [Reviews](#rev)

This document provides details about the REST API endpoints exposed by the Property Service. The service allows users to create their own profile,manage properties, place bids, create reviews and retrieve property information.

## Getting started

To get started, you need to change directory to /server and run:
```bash
npm start
```

When the server starts successfully, it outputs the following message to the console:
'Connected to database
Server started on 3030'

### Error Responses

If there is an error processing a request, the API will respond with an appropriate HTTP status code and a JSON object containing an error message.

Example error response:

```json
{
  "message": "Invalid request, missing required parameter."
}
```
## Authorized request 

To access some of the endpoints (e.g. creating and managing posts, placing a bid), authentication is required. Users need to include a valid JWT token in the authorization header of their HTTP requests.

```
Request Headers:
"Authorization": {accessToken}
```

All authentication-related endpoints are under the `/users` namespace.

### Register

To create a new user send a `POST` request to `/users/register` with email and password. Upon successfull request, the service creates a session and returns an authorized token (accessToken).

#### Example regsiter request
```
POST /users/register
Content-Type: application/json
```
Request body:
```js
{
  email: "example_email",
  password: "example_pass"
}
```
#### Example regsiter response
```js
{
    _id: {id generated by the service},
    email: "example_email",
    accessToken: {generatedAccessToken}
}
```
### Login
To log in as an already created user send `POST` request to `/users/login`. The service authenticates the user and returns an object with accessToken for subsequent requests.
#### Example login request
```
POST /users/login
Content-Type: application/json
```
Request body:
```js
{
  email: "example_email",
  password: "example_pass"
}
```
#### Example login response
The service responds with the object similar to what is found in the [registration](#example-request) process.

### Logout
To logout the current user, send an authorized `GET` request to `/users/logout`. The service blakclists the token and responds with 204 - No Content.

### Property service
The base url for accessing the properties is `/data/catalog`
### Get all Properties
To retrieve a list of all properties send `GET` request to `/data/catalog` with the following optional queries:

* search : Filters properties by name or location (case-insensitive).
* sort : Sorts the properties based on a specified property and order ("asc" for ascending and "desc" for ascending).
* page : Specifies the page number to retrieve.
* limit : Limits the number of properties returned for the required page (default is 5). 

#### Example properties request

To get all properties send a `GET` request to `/data/catalog`.
The server responds with an array of objects representing different real estate properties. Beside the regular properties (as in object keys), the objects include automatically generated properties, which are as follows:

The server responds with an object with two properties - pages and data, where
pages - an object with pagination related properties.
data - an array with real estate property objects.


```json
{
  "pages" : {
    "pageCount" : "Number - Total number of pages (taking into account the filtering and limit)",
    "next" : "Boolean - Indicates whether the next page exists.",
    "previous" : "Boolean - Indicates whether the previous page exists."
  },
  "data" : "an array of objects representing different real estate properties"
}
```
Beside the regular properties (as in object keys), the objects include automatically generated properties, which are as follows:

##### Automatically generated properties:
    * _id - Unique ID in the form of string.
    * createdAt - Time stamp of the creation.
    * updatedAt - The time of the last update.

The whole server response would like this:
```json
{
  "pages":{
    "pageCount" : 3,
    "next" : true,
    "previous" : true
  },
  "data":[
    {
      "_id": "{generatedId}",
      "name": "Example house",
      "location": "Some town, Some country",
      "area": 200,
      "imageUrl": "{image URL}",
      "description": "Some property description",
      "price": 400900,
      "_ownerId": "{generatedIdOfOwner}",
      "createdAt": "{generatedDate}",
      "updatedAt":  "{generatedDate}",
      "currentBidder":"{generatedIdOfBidder}",
      "rating": "{average rating}",
      "reviews": [
        "{reviewId}",
        "{reviewId}"
        ]
    },
  ]
}
```

#### Search
Append `search={match}` to the query paramaters, where {match} is a string. The server filters the properties by name or location with the matching string (case insensitive). For example to get all properties which are located in USA send the following request:
```
GET /data/catalog?search=usa
```
#### Sorting
To sort the real estate properties by some of their properties append `sort={propertyToSort} {order}` as encoded URI string. Where order could be `asc` for ascending and `desc` for descending order. 
To get all properties, sorted by time of creation send the following request:
```
GET /data/catalog?sort=createdAt%20desc
```
#### Page and limit
To get a certain page of properties with a certain items per page append `page={number}` and `limit={count}` to the query paramaters. The server provides the precise count of records for the page in the database (taking into account the sorting), granted that the corresponding number of records exists. In the absence of the 'limit' query, the server will return a default of 5 properties per page. Note that if `sort` query is not passed, the default properties are sorted by time of creation and ascending order (Oldest first). The sort is always done before the limit, so the order of the query parameters does not matter.

#### Example including all query paramaters
To get the first page with 3 items per page of the three most recently created properties which include "house" in their names, use the following request:

```
GET /data/catalog?page=1&limit=3&search=house&sort=createdAt%20desc
```
### Get single property
To get a single property send a `GET` request to `/data/catalog/{id}`, where _id_ is the server generated ID of the property. The server responds with an object representing the requested property. The object is in the same form as the object returned from the [Get all](#get-all-properties) request. The difference is that the "reviews" property is populated and sorted by date of creation (The newest reviews come first). 

The "_ownerId" inside the review object is also populated (deep population). 
Check the [review structure](#review-structure) for detailed information on the reviews.

The whole object with all its populations looks like this:
```json
{
    "_id": "some ID",
    "name": "example name",
    "location": "Town, Country",
    "area": 120,
    "imageUrl": "link to image",
    "description": "Some description.",
    "price": 600000,
    "_ownerId": "owner ID",
    "createdAt": "date of creation",
    "updatedAt": "date of last update",
    "rating": 4.5,
    "currentBidder": {
        "_id": "some ID",
        "email": "example@email.com",
    },
    "reviews": [
        {
            "_id": "some ID",
            "rating": 4,
            "content": "Example review",
            "_ownerId": {
                "_id": "some ID",
                "email": "exmaple@mail.com"
            },
            "_propertyId": "some ID",
            "createdAt": "date of creation",
            "updatedAt": "date of last update",
            "__v": 0
        }
    ]
}
```

### Create property
Creation of new property is done by sending an [authorized](#authorized-request) `POST` request to `/data/catalog`. Beside the authorization, the following header must be provided:
```json
"Content-Type":"application/json"
```
The request body must consist of an object containing the following properties:
| Property    | Data type                                   |
| ----------- | --------------------------------------------|
| name        | String with at least 4 characters           |
| location    | String with at least 4 characters           |
| area        | Number bigger than 50                       |
| imageUrl    | String starting with "http://" or "https://"|
| description | String between 10 and 200 characters long   |
| price       | A positive Number                           |

On succesfull creation, the server returns the object created with its [automatically generated](#automatically-generated-properties) proeprties.

### Edit property
This action can be done only by the creator of the property post. To edit the property send an authorized `PUT` request to `/data/catalog/${id}`, where _id_ is the server generated ID of the property. The content type header should be included and the requst body should be the same as the body passed at property creation. The server overwrites the property values and returns the same object as in [create](#create-property)

### Delete property
The owner of the property can delete the post, by sending an authorized `DELETE` request to `/data/catalog/${id}`, where _id_ is the server generated ID of the property.

***Note!*** - The server returns a 204 - No Content status code. If you attempt to parse the result as JSON, you might encounter an error.

### Place a bid
Every logged in user can place a bid on properties (except on his own). To place a bid, send an authorized `POST` request to `/data/catalog/{id}/bid`, where _id_ is the server generated ID of the property. The request body should be an object with the following properties:
```
id - The ID of the property
userId - The ID of the User
price - The price of the placed bid
```
Note that if the passed price is less than the current property price, the server will return an error. Otherwise, if everything is correct, the server returns a status code 204 - No Content.

### Reviews 

Every user can post a review on the properties (Except on his own posts).

#### Review structure
Each review object has the following structure:
```json
{
  "_id": "{generatedId}",
  "rating": "{Number between 1 and 5}",
  "content": "{Review content}",
  "_ownerId": "{id reffering to the user}",
  "createdAt": "{time of creation}",
  "updatedAt": "{time of last update}",
}
```
If `_ownerId` is populated (Details and Profile page), it represents the values of the email and the id of the user who created the review.